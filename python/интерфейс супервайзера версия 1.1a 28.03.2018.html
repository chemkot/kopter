<!DOCTYPE html>
<html>
<head>
	<meta http-equiv='X-UA-Compatible' content='IE=edge' />
	<meta http-equiv='content-type' content='text/html; charset=utf-8'/>

	<style type='text/css'>
		body, div, p, table {
			font-size:10pt;
			font-family:Verdana;
		}

		img{border:none}
		
	</style>
	
</head>

<body>
<hr>
Версия документа 1.1a (28.03.2018)
<hr>
Супервайзер - сервер TCP/IP, слушающий порт и выполняющий команды ниже. Также постоянно опрашивает главную плату по tty, чтобы выполнить и команды, пришедшие по радиоканалу; управляет железом коптера вместе с интерпретатором.<br/>
При старте миссии записывает текущее положение и может вернуть коптер в него оптимальным образом (не выполняя действия по логу в обратном порядке, а облетая препятствия лететь напрямую). 
<hr>
Список команд: 
<ol>
<ol>
<li>полная остановка коптера (с остановкой миссии)</li>
<li>запустить FTP сервер для загрузки/выгрузки файлов</li>
<li>остановить FTP сервер</li>
<li>запустить скомпилированную миссию</li>
<li><strike>задать тип реагирования на событие</strike></li>
<li>вернуть коптер в начальную точку</li>
</ol>
</ol>должен отправлять команды об аварийном останове системы, в случае невозможности выполнения мисcии (система обнаружила нессответствие/ошибку/батарея садится/связь пропала/миссия вылетела или завершилась)
<hr>
Обмен строками по аналогии с NMEA0183, с небольшими упрощениями:
<pre>$MEС01,55,&lt;LF&gt;</pre>
 
<pre>$PUС01,55,&lt;LF&gt;</pre>
 
<pre>$MEС02,56,21,admin,123456,&lt;LF&gt;</pre>

<pre>$CPA01,55,OK,&lt;LF&gt;</pre>
 
<pre>$CPE01,LOW BATTERY,&lt;LF&gt;</pre>

<ul>
<li>сообщение начинается с $ (hex 24);</li>
<li>далее идут 2 буквы - идентификатор источника сообщения</li>
<ul>
<li>PU - сообщение от пульта</li>
<li>CP - сообщение от коптера</li>
<li>SM - сообщение от симулятора</li>
<li>ME - сообщение от редактора миссий</li>
</ul>
<li>дальше три цифры/буквы</li>
<ul>
<li>первая C означает принадлежность к семейству команд управления супервайзера, далее идет номер команды 00..99.</li>
</ul>
<li>дальше идут аргументы (цифры и буквы через запятую), первый аргумент - циклический номер сообщения, 0..255</li>
<li>последний аргумент (может опускаться; запятая остается) - восьмибитная XOR-сумма всех символов (включая ',' и '^') в строке между «$» и «*» приведенная к двум ASCII-символам в верхнем регистре для 16-ричного представления байта (0-9,A-F)</li>
<li>завершает все 
<pre>&lt;LF&gt;</pre>
 - hex 0A (перенос строки)</li>
</ul>
<hr>
Супервайзер в ответ на команды присылает циклический номер пакета, ОК или аргументы. Исключение - случаи ошибок, где сообщение вида  
<pre>$CPE01,MESSAGE,&lt;LF&gt;</pre>
Супервайзер отвечает командами типа <code>A01</code> или <code>A02</code> на все команды. На команды, которые не требуют времени на физическое выполнение результат содержится в аргументах. На команды, требующих физического выполнение интерпретатор сначала присылает <code>A01</code>, означающую успешный прием, а по завершению выполнения - <code>A02</code>. Примеры:
<ol>
<ol>
<li>редактор миссий посылает команду на остановку 
<pre>$MEС01,55,&lt;LF&gt;</pre>
 интерпретатор отвечает -> 
<pre>$CPA02,55,OK,&lt;LF&gt;</pre>
</li>
<li>редактор миссий посылает команду запуска FTP 
<pre>$MEС02,56,21,admin,123456,&lt;LF&gt;</pre>
 интерпретатор отвечает ->  
<pre>$CPA02,56,OK,&lt;LF&gt;</pre>
</li>
<li>редактор миссий посылает команду на возврат коптера в исходную точку 
<pre>$MEС06,60,&lt;LF&gt;</pre>
  интерпретатор отвечает -> 
<pre>$CPA01,60,OK,&lt;LF&gt;</pre>
 после физического выполнения отвечает ->  
<pre>$CPA02,60,OK,&lt;LF&gt;</pre>
</li>
</ol>
</ol><strike>Максимальная длина сообщения ограничена 82 символами (NMEA 0183 rev 3.0)</strike><br/>
<br/>
<br/>
<br/>
<br/>
<table border="1">
<tr>
<td>Пример команды</td>
<td>Элементарная функция</td>
<td>Пример возвращаемой строки</td>
</tr>
<tr>
<td>
<pre>$MEС01,55,&lt;LF&gt;</pre>
</td>
<td>полная остановка коптера (с остановкой миссии)</td>
<td>
<pre>$CPA02,55,OK,&lt;LF&gt;</pre>
 </td>
</tr>
<tr>
<td>
<pre>$MEС02,56,21,USER,PASS,&lt;LF&gt;</pre>
</td>
<td>запустить FTP сервер для загрузки/выгрузки файлов, 21 - порт, USER и PASS - пароль ASCII без \n, $, запятой</td>
<td>
<pre>$CPA02,56,OK,&lt;LF&gt;</pre>
</td>
</tr>
<tr>
<td>
<pre>$MEС03,57,&lt;LF&gt;</pre>
 </td>
<td>остановить FTP сервер </td>
<td>
<pre>$CPA02,57,OK,&lt;LF&gt;</pre>
</td>
</tr>
<tr>
<td>
<pre>$MEС04,58,MISSION1/file1.exe 127.0.0.1:50,&lt;LF&gt;</pre>
 </td>
<td>запустить скомпилированную миссию </td>
<td>
<pre>$CPA02,58,&lt;LF&gt;</pre>
</td>
</tr>
<tr>
<td>
<pre>$MEС05,59,LOWBAT,20,WAITING,&lt;LF&gt;</pre>
 
<pre>$MEС05,59,LOWERROR,CONTINUE,&lt;LF&gt;</pre>
 </td>
<td>задать тип реагирования на событие. События:: 
<ul>
<li>LOWBAT,56 - разряд АКБ (56 - граничный уровень заряда в %);</li>
<li>LINKFAULT - на потерю связи;</li>
<li>LOWERROR - на некритическую ошибку;</li>
<li>HARDERROR - на критическую ошибку</li>
</ul>
Типы реагирования:
<ul>
<li>CONTINUE - продолжение выполнения программы</li>
<li>WAITING - переход в режим энергосбережения и ожидание команды на спуск</li>
<li>RETURN - самостоятельный возврат к точке старта/точке завершения миссии (куда ближе)</li>
<li>LANDING - самостоятельный спуск</li>
</ul>
</td>
<td>
<pre>$CPA02,59,OK,&lt;LF&gt;</pre>
</td>
</tr>
<tr>
<td>
<pre>$MEС06,60,&lt;LF&gt;</pre>
 </td>
<td>вернуть коптер в начальную точку</td>
<td>
<pre>$CPA01,60,OK,&lt;LF&gt;</pre>

<pre>$CPA02,60,OK,&lt;LF&gt;</pre>
</td>
</tr>
</table><br/>
</body>
</html>
